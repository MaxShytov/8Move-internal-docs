# Клиенты (Clients)

Модуль клиентов обеспечивает полное управление клиентской базой: контактные данные, адреса доставки, зоны, ценообразование, выставление счетов, пользователи клиентского портала и импорт из CSV.

---

## Список клиентов

### Доступ

Боковая панель → **Clients** или Дашборд → **All Clients**

### Таблица клиентов

| Колонка | Описание |
|---------|----------|
| **Name** | Аватар/логотип + имя клиента + тип (Person :material-account: / Company :material-domain:) + бейдж «BLOCKED» (красный, если заблокирован) + ID + Bexio ID (если есть) |
| **Industry** | Список отраслей (через запятую) |
| **Contact Information** | Основной email + основной телефон + чип «+N» для дополнительных контактов |
| **Delivery Address** | Основной адрес + цветной бейдж зоны доставки + GPS-координаты + ссылка на карту |
| **Invoicing** | Период выставления счетов + условия оплаты + лимиты веса + способ доставки |
| **Pricing** | Категория цен + количество индивидуальных цен (кликабельный чип) |
| **User / Contact** | Привязанный пользователь портала + контактное лицо |

#### Чип дополнительных контактов «+N»

При нажатии на чип «+N» открывается всплывающее окно со всеми телефонами и email клиента. Каждый контакт показывает:

- Тип (Main, Mobile, Fax, Other)
- Пометку :material-star: для основного контакта
- Кнопки: копировать, написать email, позвонить

### Фильтры

| Фильтр | Тип | Варианты |
|--------|-----|----------|
| **Поиск** | Текст | По имени, email, телефону |
| **Client Type** | Чипы | All / Company / Person |
| **Industry** | Выпадающий список | All + все отрасли |
| **Delivery Zone** | Выпадающий список | All + все зоны доставки |
| **No Industry** | Переключатель | Показать клиентов без отрасли |
| **No Delivery Zone** | Переключатель | Без зоны доставки |
| **No Address** | Переключатель | Без адреса |
| **Invoicing Period** | Выпадающий список | All / Manual / Per Order / Daily / Weekly / Monthly |
| **No Invoicing** | Переключатель | Без настроек выставления счетов |
| **Price Category** | Выпадающий список | All + все категории цен |
| **No Price Category** | Переключатель | Без категории цен |
| **Individual Prices** | Чипы | All / Has individual prices / Without individual prices |

### Сортировка

Доступные поля: ID, Name, Type (тип клиента), Email.

---

## Создание и редактирование клиента {#client-form}

### Тип клиента

В верхней части формы — переключатель **Company** :material-domain: / **Person** :material-account:. Выбор типа определяет набор полей ниже.

---

### Основная информация

#### Логотип / фото

Круглый аватар (128px). Нажатие открывает меню:

- **Gallery** — выбрать из галереи
- **Camera** — сделать фото
- **Remove Logo** — удалить

#### Поля для Company (компания)

| Поле | Описание | Обязательное |
|------|----------|:------------:|
| **Company Name** | Название компании | :white_check_mark: |
| **Official Name** | Официальное (юридическое) название | — |

#### Поля для Person (физ. лицо)

| Поле | Описание | Обязательное |
|------|----------|:------------:|
| **Salutation** | Обращение: None / Mr / Mrs / Mr & Mrs | — |
| **First Name** | Имя | :white_check_mark: |
| **Last Name** | Фамилия | :white_check_mark: |

#### Общие поля (оба типа)

| Поле | Описание | Обязательное |
|------|----------|:------------:|
| **Industry** | Отрасль (множественный выбор) | — |
| **Description** | Описание клиента (многострочное) | — |
| **Default Language** | Предпочтительный язык: EN / DE / FR / IT | — |

---

### Бизнес-информация (только Company)

| Поле | Описание | Обязательное |
|------|----------|:------------:|
| **Fiscal Number** | Фискальный номер | — |
| **VAT Number** | ИНН (VAT) | — |

---

### Контактная информация {#contact-info}

#### При создании

Простые поля:

| Поле | Описание | Валидация |
|------|----------|-----------|
| **Email** | Email-адрес | Должен содержать `@` |
| **Phone** | Телефон | Формат: +41 79 123 45 67 |
| **Website** | Веб-сайт | Автоматически добавляет `https://` |

#### При редактировании

Вместо простых полей отображаются полноценные секции с множественными записями:

##### Телефоны

Список телефонных номеров. Каждый номер содержит:

| Поле | Описание | Обязательное |
|------|----------|:------------:|
| **Phone Number** | Номер телефона | :white_check_mark: |
| **Phone Type** | Main / Mobile / Fax / Other | :white_check_mark: |
| **Label** | Произвольная метка | — |
| **Primary** | Отметить как основной | — |

##### Email-адреса

Список email-адресов. Каждый адрес содержит:

| Поле | Описание | Обязательное |
|------|----------|:------------:|
| **Email** | Email-адрес | :white_check_mark: |
| **Label** | Произвольная метка | — |
| **Primary** | Отметить как основной | — |

---

### Адреса {#addresses}

#### При создании

Показывается информационный блок с кнопкой **Save and Add Address** — при нажатии клиент сначала сохраняется, затем открывается форма адреса.

#### При редактировании

Список существующих адресов с возможностью добавления, редактирования и удаления.

##### Форма адреса

| Поле | Описание | Обязательное |
|------|----------|:------------:|
| **Label** | Метка адреса (например, «Склад», «Офис») | — |
| **Address Type** | Other / Primary / Billing / Registered | — |
| **Address Line 1** | Улица, дом | :white_check_mark: |
| **Address Line 2** | Квартира, этаж, офис | — |
| **City** | Город | :white_check_mark: |
| **Postal Code** | Почтовый индекс | :white_check_mark: |
| **State / Canton** | Кантон / провинция | — |
| **Country Code** | Код страны (2 буквы, по умолчанию «CH») | :white_check_mark: |
| **Comment** | Комментарий к адресу | — |
| **Latitude** | Широта (GPS) | — |
| **Longitude** | Долгота (GPS) | — |

##### Зона доставки (только при редактировании адреса)

Выбор зоны доставки отображается как чипы:

- **No zone assigned** — без зоны
- Список всех активных зон с цветным индикатором

Зона **сохраняется мгновенно** при выборе (без необходимости нажимать Save).

Под чипами отображается статус геопривязки:

| Статус | Цвет | Описание |
|--------|------|----------|
| :material-check-circle: Внутри зоны | Зелёный | Координаты адреса внутри полигона зоны |
| :material-alert: Вне зоны | Оранжевый | Адрес находится вне назначенной зоны (но внутри другой) |
| :material-lightbulb: Рекомендация | Синий | Зона не назначена, но координаты попадают в зону — предложение назначить |
| :material-help-circle: Нет координат | Серый | GPS-координаты не указаны — зону нельзя определить автоматически |

Ниже отображается **карта Google Maps** с полигонами зон доставки и маркером адреса.

---

### Ценообразование {#pricing}

Секция доступна только при **редактировании**.

#### Категория цен

Выпадающий список:

- **No price category** — без категории
- Список всех категорий ценообразования поставщика

При выборе категории клиенту будут автоматически применяться цены этой категории (если они установлены для продуктов).

#### Индивидуальные цены

Таблица (только для чтения) индивидуальных цен продуктов для этого клиента:

| Колонка | Описание |
|---------|----------|
| **Name** | Название продукта |
| **Unit** | Единица измерения |
| **Price** | Цена + валюта |

!!! tip "Редактирование индивидуальных цен"
    Для управления индивидуальными ценами перейдите в форму [продукта](products.md#individual-prices) → раздел «Individual Client Prices».

---

### Управление доступом {#access-control}

Доступно только при **редактировании**.

| Элемент | Описание |
|---------|----------|
| **Client Blocked by Supplier** | Переключатель блокировки клиента поставщиком |
| **Client Self-Blocked** | Индикатор (только для чтения) — клиент заблокировал сам себя |

---

### Настройки выставления счетов {#invoicing}

Доступно только при **редактировании**.

| Поле | Описание |
|------|----------|
| **Invoicing Period** | Default (от поставщика) / Manual / Per Order / Weekly / Monthly |
| **Weekly Day** | День недели (только для Weekly) |
| **Monthly Day** | День месяца 1–28 (только для Monthly) |
| **Payment Terms (days)** | Срок оплаты в днях |
| **Invoice Delivery Method** | Email / Post |
| **Fulfillment Scheme** | Схема выполнения: Default from Supplier + варианты из API |

Под полями отображаются синие чипы с настройками поставщика по умолчанию для справки.

При выборе Weekly/Monthly — зелёный чип показывает расписание (например, «Every Monday»).

---

### Ограничения веса заказов {#weight-limits}

| Поле | Описание |
|------|----------|
| **Min Order Weight (kg)** | Минимальный вес заказа |
| **Max Auto Order Weight (kg)** | Максимальный вес для автозаказа |

Если поля не заполнены — используются настройки поставщика (показаны в синих чипах).

---

### Уведомления

| Поле | Описание |
|------|----------|
| **Order Notification Recipient** | Пользователь-получатель уведомлений о заказах (выбор из привязанных пользователей) |

---

### Пользователи клиента {#client-users}

Доступно только при **редактировании**.

Таблица привязанных пользователей клиентского портала:

| Колонка | Описание |
|---------|----------|
| **Email** | Email пользователя |
| **Name** | Имя и фамилия |
| **Role** | Роль |
| **Действия** | Изменить роль / Удалить привязку |

#### Добавление пользователя

1. Нажмите **Add User**
2. Введите **Email** пользователя
3. При необходимости — **First Name** и **Last Name** (если пользователь новый)
4. Выберите **Role**: Admin / Manager / Courier
5. Нажмите **Add**

!!! info "Поведение"
    Если пользователь с таким email уже существует — он будет привязан к клиенту. Если нет — будет создан новый пользователь.

---

### Контактные лица {#contacts}

Доступно только при **редактировании**. Для компаний — список контактных лиц.

Таблица:

| Колонка | Описание |
|---------|----------|
| **Name** | Имя и фамилия |
| **Email** | Email |
| **Phone** | Телефон (стационарный или мобильный) |
| **Role** | Должность/роль (например, «Sales Manager») |
| **Действия** | Редактировать / Удалить |

#### Добавление / редактирование контакта

| Поле | Описание |
|------|----------|
| **First Name** | Имя |
| **Last Name** | Фамилия |
| **Email** | Email |
| **Phone** | Телефон |
| **Mobile** | Мобильный телефон |
| **Role** | Должность/роль |

---

### Синхронизация Bexio {#bexio-sync}

Доступно только при **редактировании**. Секция только для чтения.

| Поле | Описание |
|------|----------|
| **Provider** | Название провайдера синхронизации |
| **External ID** | ID во внешней системе |
| **Sync Status** | Статус синхронизации (synced / error) |
| **Last Sync** | Дата и время последней синхронизации |
| **Error** | Сообщение об ошибке (если есть) |

---

## Импорт клиентов из CSV {#csv-import}

### Запуск импорта

В списке клиентов нажмите **Import** → **Import Bexio CSV**.

### Процесс импорта

1. Выберите **поставщика** (автоматически выбран текущий)
2. Нажмите **Select CSV file** и выберите файл
3. Система проанализирует файл и покажет количество найденных строк
4. Настройки:
    - **Dry Run** — тестовый запуск без сохранения данных
    - **Skip Geocoding** — пропустить геокодирование адресов (ускоряет импорт)
5. Нажмите **Start Import**
6. Дождитесь завершения (полоса прогресса с индикацией текущей строки)

### Результаты импорта

После завершения отображается диалог с результатами:

| Показатель | Описание |
|------------|----------|
| **Total Rows** | Общее количество строк в файле |
| **Created** | Новых клиентов создано (зелёным) |
| **Updated** | Существующих обновлено |
| **Skipped** | Пропущено |
| **Errors** | Ошибки (красным) |
| **Manual Review** | Требуют ручной проверки (оранжевым) |

Дополнительные секции:

- **Errors** — детализация ошибок
- **Manual Review** — клиенты, требующие проверки (с ID Bexio, именем и причиной)
- **Duplicate Emails** — найденные дублирующиеся email-адреса

**Действия:**

- **View Import History** — перейти к истории импортов
- **Email Import Report** — отправить отчёт по email
- **Close** — закрыть

---

### История импортов {#import-history}

Перейдите через **Import** → **Import History** или из результатов импорта.

Список прошлых импортов с пагинацией (20 на страницу). Каждая карточка показывает:

- **Статус**: :material-check-circle:{ .green } успешно / :material-alert:{ .orange } частично / :material-alert-circle:{ .red } ошибка / :material-undo:{ .grey } откачено
- **Дата и время**
- **Бейджи**: «DRY RUN» (янтарный), «ROLLED BACK» (серый)
- **Сводка**: количество строк, созданных, обновлённых, ошибок
- **Имя файла**
- **Длительность**

#### Развёрнутая информация

Нажмите на карточку для раскрытия деталей:

- **Errors** — список ошибок
- **Manual Review** — список для ручной проверки
- **Duplicate Emails** — дубликаты
- **Row Details** — детализация по каждой строке (действие + результат)

#### Откат импорта

Для незатестированных (не DRY RUN), не откаченных импортов с созданными клиентами доступна кнопка **Rollback Import** (красная).

После подтверждения показывается результат:

- Количество удалённых клиентов
- Количество заблокированных
- Детали по каждому клиенту

---

## FAQ

??? question "Как перенести клиента из Person в Company?"
    Переключите тип клиента в верхней части формы. Обратите внимание: при смене типа поля формы изменятся, но данные сохранятся.

??? question "Как назначить зону доставки адресу?"
    Перейдите в редактирование адреса клиента. В секции «Delivery Zone» выберите зону из чипов. Зона сохраняется мгновенно.

??? question "Можно ли откатить импорт CSV?"
    Да, если импорт был выполнен не в режиме Dry Run. Перейдите в «Import History», раскройте нужный импорт и нажмите «Rollback Import».

??? question "Как добавить пользователя портала к клиенту?"
    В форме редактирования клиента перейдите в секцию «Client Users» → «Add User». Введите email — если пользователь существует, он будет привязан; если нет — создан новый.
