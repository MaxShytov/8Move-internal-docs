# Заказы (Orders)

Модуль заказов позволяет создавать, редактировать и отслеживать заказы клиентов на всех этапах — от формирования корзины до завершения доставки.

---

## Список заказов

### Доступ

Боковая панель → **Orders** или Дашборд → **View All Orders**

### Таблица заказов

| Колонка | Описание | Сортировка |
|---------|----------|:----------:|
| **Status** | Цветной бейдж со статусом заказа (см. [Статусы заказов](#statuses)) | — |
| **Client** | Имя клиента (жирным) + номер заказа + ID заказа | :white_check_mark: (по номеру) |
| **Delivery Address** | Адрес доставки + цветной бейдж зоны доставки + GPS-координаты | — |
| **Dispatch Slot** | Название слота отправки | — |
| **Delivery Date** | Дата доставки (формат: дд/мм/гггг) | — |
| **Total** | Сумма заказа + валюта + вес (кг) | :white_check_mark: (по сумме) |

Нажатие на строку открывает форму редактирования заказа.

### Фильтры

| Фильтр | Тип | Описание |
|--------|-----|----------|
| **Поиск** | Текстовое поле | Поиск по номеру заказа, имени клиента и другим полям |
| **Status** | Выпадающий список | Фильтр по статусу заказа (загружается из API) |
| **Assignment** | Переключатель | «Unassigned Only» — показать только заказы, не привязанные к маршруту; «All Orders» — все |
| **Delivery Date** | Выбор даты | Показать заказы на конкретную дату доставки |

### Пагинация

Постраничная навигация с возможностью выбора количества элементов на странице (по умолчанию 25).

### Создание нового заказа

Нажмите кнопку **+ Add Order** в верхнем правом углу.

---

## Статусы заказов {#statuses}

| Статус | Цвет | Описание |
|--------|------|----------|
| **Cart** / **Created Cart** | :material-circle:{ .grey } Серый | Черновик заказа, корзина формируется |
| **Ordered** / **Pending** | :material-circle:{ .orange } Оранжевый | Заказ отправлен, ожидает обработки |
| **Confirmed** / **Accepted** | :material-circle:{ .blue } Синий | Заказ подтверждён поставщиком |
| **In Transit** / **Dispatched** | :material-circle:{ .purple } Фиолетовый | Заказ в пути |
| **Delivered** / **Completed** | :material-circle:{ .green } Зелёный | Доставка выполнена |
| **Cancelled** / **Rejected** | :material-circle:{ .red } Красный | Заказ отменён или отклонён |

---

## Создание и редактирование заказа

Форма заказа разделена на две колонки:

- **Левая колонка** (основная) — обязательные данные: клиент, адрес, слот, продукты
- **Правая колонка** — сводка заказа + история (только при редактировании)

### Номер заказа

Номер заказа отображается в заголовке формы. Для редактирования нажмите иконку :material-pencil: рядом с номером.

- Если оставить поле пустым — номер будет сгенерирован автоматически
- Можно ввести произвольный номер

### Основные поля

#### Выбор клиента

Нажмите на поле **Client** для открытия диалога выбора клиента.

В диалоге доступно:

- **Поиск** по имени, email, телефону
- Список клиентов с аватаром, названием, ID и ИНН
- Текущий выбранный клиент отмечен галочкой :white_check_mark:

!!! tip "Автозаполнение адреса"
    При выборе клиента **основной адрес** (primary) подставляется автоматически. Если у клиента есть основной адрес — вам не нужно выбирать его вручную.

#### Выбор адреса доставки

Нажмите на поле **Delivery Address** для открытия диалога.

Диалог показывает все адреса выбранного клиента. Каждый адрес содержит:

- Название/метку адреса
- Полный адрес
- Тип: Primary (основной), Billing (для счетов), Registered (юридический)
- Комментарий (если есть)

При выборе адреса автоматически заполняется **зона доставки**.

#### Выбор слота доставки

После выбора адреса появляются доступные слоты доставки в виде чипов.

Каждый слот показывает:

- **Название** слота
- **Дату** (например, «Пн 21.2»)
- **Индикатор вместимости** (если включён контроль веса):
    - Полоса прогресса: зелёная / оранжевая (осталось < 30%) / красная (полный)
    - Оставшаяся / общая вместимость в кг
    - Индикатор «fits» :material-check: или «no space» :material-close:

Для выбора другой даты нажмите чип **Other** :material-calendar: — откроется календарь для выбора даты, затем диалог выбора слота на эту дату.

!!! note "Первый слот"
    При первом открытии формы автоматически выбирается первый доступный слот.

#### Дополнительные поля

| Поле | Описание |
|------|----------|
| **Delivery Price** | Стоимость доставки (по умолчанию 0) |
| **Prices include VAT** | Переключатель «цены включают НДС» (берётся из настроек поставщика) |

### Продукты заказа

В нижней части левой колонки расположена таблица продуктов заказа.

#### Добавление продукта

1. Нажмите кнопку **Add Product**
2. В диалоге нажмите на поле «Select Product» — откроется диалог поиска продуктов
3. Выберите продукт из списка (показываются: изображение, название, артикул, цена, статус)
4. Укажите **количество** (по умолчанию 1)
5. Нажмите **Add**

!!! warning "Неактивные продукты"
    Продукты со статусом «Inactive» отображаются в списке, но **не могут быть выбраны**.

#### Управление количеством

Для каждого продукта в таблице доступны кнопки **+** и **-** для изменения количества.

#### Удаление продукта

Нажмите иконку :material-delete: справа от строки продукта.

#### Массовое редактирование (Bulk Edit) {#bulk-edit}

Для быстрого редактирования всех продуктов нажмите **Edit All Products**.

Открывается полноэкранный диалог:

- **Поиск** продуктов по названию
- Таблица со всеми активными продуктами: изображение, название, артикул, цена, количество, итого
- Продукты с количеством > 0 подсвечиваются
- Стандартная пагинация (25 на страницу)

**Горячие клавиши:**

| Клавиша | Действие |
|---------|----------|
| ++tab++ | Перейти к следующему полю количества |
| ++enter++ | Подтвердить и перейти к следующему продукту |
| ++arrow-up++ / ++arrow-down++ | Навигация между полями количества |
| ++ctrl+enter++ (или ++cmd+enter++ на Mac) | Сохранить все изменения |

При сохранении:

- Продукты с количеством > 0, которых не было → **добавляются**
- Продукты с изменённым количеством → **обновляются**
- Продукты с количеством = 0, которые были → **удаляются**

!!! tip "Bulk Edit для нового заказа"
    Если вы нажмёте «Edit All Products» на **новом** (несохранённом) заказе, он будет автоматически сохранён перед открытием диалога массового редактирования.

---

## Сводка заказа (Order Summary)

Правая колонка содержит карточку **Order Summary** с расчётными данными:

| Поле | Описание |
|------|----------|
| **Items** | Общее количество единиц товара |
| **Weight** | Общий вес заказа (кг) |
| **Subtotal** | Сумма без НДС |
| **Tax** | Сумма НДС |
| **Total** | Итоговая сумма (выделена жирным, цветом) |

Бейдж статуса заказа отображается в заголовке карточки (только при редактировании).

---

## Действия со статусами {#status-actions}

В зависимости от текущего статуса заказа в нижней панели (footer) появляются дополнительные кнопки:

| Статус | Кнопка | Действие |
|--------|--------|----------|
| **CART** | :material-cart-check: **Checkout** | Оформить заказ (перевести в следующий статус) |
| **SUPPLIER_MANAGER_REVIEW** | :material-check-circle-outline: **Approve** | Одобрить заказ |

!!! warning "Проверка вместимости слота"
    При нажатии **Checkout**, если вместимость слота превышена, вместо обычного сообщения об ошибке появится **отдельный диалог** с подробной информацией:

    - Заголовок «Slot Capacity Exceeded»
    - Описание проблемы
    - Текст ошибки от сервера
    - Подсказка по решению

---

## Блокировка заказа {#lock}

Заказ может быть заблокирован системой доставки (например, когда маршрут уже сформирован).

### Что происходит при блокировке

- Появляется **оранжевый баннер** «Order Locked» вверху формы
- Кнопка **Save** неактивна
- Кнопка **Delete** скрыта
- Кнопки **Checkout** и **Approve** скрыты
- При попытке сохранить заблокированный заказ появится ошибка

### Разблокировка

Нажмите кнопку **Unlock Order** :material-lock-open: на баннере. Разблокировка происходит мгновенно.

---

## История заказа {#history}

При редактировании заказа в правой колонке (ниже сводки) может отображаться карточка **History** с информацией о доставке. Карточка свёрнута по умолчанию — нажмите для раскрытия.

### Информация о маршрутной остановке (Route Stop)

| Поле | Описание |
|------|----------|
| **Route** | ID маршрута |
| **Stop Sequence** | Порядковый номер остановки |
| **Status** | Статус остановки (цветной бейдж) |
| **Arrival Time** | Время прибытия (дд.мм.гггг чч:мм) |
| **Departure Time** | Время отъезда |
| **Duration** | Продолжительность остановки (рассчитывается автоматически) |
| **Failure Reason** | Причина неуспешной доставки (если есть, показывается красным) |
| **Notes** | Заметки водителя |

### Статусы остановок

| Статус | Иконка | Цвет |
|--------|--------|------|
| Completed / Delivered | :material-check-circle: | Зелёный |
| Failed / Cancelled | :material-cancel: | Красный |
| In Progress / En Route | :material-car: | Синий |
| Pending / Scheduled | :material-clock-outline: | Оранжевый |
| Arrived | :material-map-marker: | Основной цвет |

### Подписи доставки (Delivery Signatures)

Если доставка была подтверждена подписью, отображаются:

- **Изображение подписи**
- **Имя подписавшего** (Signed By)
- **Дата и время** подписи
- **Имя курьера** (Captured By) — если указано

---

## Стандартные действия

| Кнопка | Описание |
|--------|----------|
| **Save** / **Update Order** | Сохранить изменения |
| **Cancel** | Вернуться к списку заказов без сохранения |
| **Delete** | Удалить заказ (только при редактировании, только если не заблокирован) |

---

## FAQ

??? question "Как создать заказ для нового клиента?"
    Сначала создайте клиента в разделе [Клиенты](clients.md), затем вернитесь к созданию заказа — новый клиент будет доступен в списке выбора.

??? question "Почему не отображаются слоты доставки?"
    Слоты зависят от зоны доставки выбранного адреса. Убедитесь, что:

    1. Выбран клиент
    2. Выбран адрес доставки
    3. Адресу присвоена зона доставки

??? question "Можно ли изменить заказ после оформления (Checkout)?"
    Да, заказ можно редактировать на любом этапе, если он не заблокирован системой доставки.

??? question "Что значит 'Unassigned Only' в фильтре?"
    Это фильтр для заказов, которые ещё не привязаны к маршруту доставки (Route Stop). Полезен для поиска заказов, которые нужно включить в маршрут.
