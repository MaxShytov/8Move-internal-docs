# SN-01: Multi-Supplier Verification & Blocking

**ID:** SN-01 (previously BE-01)
**Status:** :material-check-circle: Completed
**Priority:** Medium
**Estimated effort:** 4-6 hours

## Apps Affected

| App | Role | Impact |
|-----|------|--------|
| :material-server: **Django Backend** | RLA filtering logic | Core — data access layer |
| :material-cellphone: **Supply Now** | Client app | Client sees all linked suppliers |
| :material-monitor-dashboard: **Back Office** | Supplier app | Supplier sees only own clients |
| :material-shield-crown: **Django Admin** | Platform admin | Admin sees all links |

## Description

Verify that the multi-supplier architecture (one client linked to multiple suppliers via `ClientSupplierLink`) works correctly across all three applications:

- **Supply Now** — client sees all their linked suppliers
- **Back Office** — supplier sees only their own clients
- **Admin Panel** — platform admin sees all links between clients and suppliers

## Scope

**In scope:**

- Manual UI testing across all 3 apps (checklist scenarios)
- Automated tests for RLA (Row-Level Access) filtering
- Verify seed data is sufficient for test scenarios
- Test `is_blocked` mechanism
- Test edge cases (0 suppliers, 1 supplier, 5 suppliers)

**Out of scope:**

- Creating new functionality
- Changing RLA logic (verification only)
- Performance testing
- UI/UX improvements

## Success Criteria

- [x] All manual test cases passed (Supply Now, Back Office, Admin)
- [x] Automated tests written and passing (13 tests in `RLAMultiSupplierTest`)
- [x] Data isolation between suppliers confirmed
- [x] Multiple links working (client with 5 suppliers)
- [x] Blocking mechanism (`is_blocked`) confirmed — both directions (supplier→client, client→supplier)
- [x] Seed data sufficient (or supplemented) for all scenarios
- [x] Issues documented and fixed

## Completed Work (2026-02-15)

- **API**: `GET /api/actors/suppliers/my-settings/` — returns suppliers with settings
- **API**: `POST /api/actors/suppliers/{id}/toggle-client-block/` — admin block toggle
- **Supply Now Profile**: real supplier data on Suppliers tab (replaced mock data)
- **Supply Now Profile**: admin block/unblock toggle with confirmation dialog
- **Supply Now Profile**: refresh button + pull-to-refresh
- **Supply Now Selector**: blocking indicators (Home tab + Categories screen)
- **Supply Now Selector**: reload suppliers on open
- **Django Admin**: improved filters for settings models

## Completed Work (2026-02-16)

- **RLA Fix**: `ClientSupplierLink.rla_roles_filter()` — supplier and client users can now see their links
- **RLA Fix**: `Order.rla_roles_filter()` — added client user filtering (clients now see their orders)
- **Tests**: 13 automated tests in `RLAMultiSupplierTest` class (all passing)
- **Seed**: Swiss Timepieces Group SA — 2 users (Philippe Aubert admin, Caroline Roux manager)
- **Seed**: Standalone Boutique — client with 0 suppliers + admin user (Thomas Weber)

## Key Risks (RESOLVED)

| Risk | Severity | Status |
|------|----------|--------|
| Order RLA filtering | :material-alert: High | :material-check: **Fixed** — added client user filtering |
| ClientSupplierLink RLA | :material-alert-outline: Medium | :material-check: **Fixed** — added `rla_roles_filter()` |
| Blocking gaps | :material-alert-outline: Medium | :material-check: Verified in UI and API |

---

!!! tip "Full task details"
    [:material-file-document-outline: View full task details](../details/BE-01-full.md) — research, test data, checklists, automated tests plan
