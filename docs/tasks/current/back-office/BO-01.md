# BO-01: Supplier Client Management — Block Clients & Edit Settings

**ID:** BO-01
**Status:** :material-checkbox-blank-outline: Not Started
**Priority:** Medium
**Estimated effort:** 6-8 hours

## Apps Affected

| App | Role | Impact |
|-----|------|--------|
| :material-monitor-dashboard: **Back Office** | Supplier app | Supplier manages client settings |
| :material-server: **Django Backend** | API endpoints | New/updated endpoints for client settings |
| :material-cellphone: **Supply Now** | Client app | Reflects supplier-side changes (read-only) |

## Description

In the Back Office app, a supplier admin should be able to manage their clients' settings via `ClientSettingsSupplierControlled`. This includes:

1. **Block/Unblock a client** — toggle `is_blocked` to prevent a client from placing orders
2. **Change Fulfillment Scheme** — switch between Delivery and Pickup
3. **Change Invoicing Period** — switch between manual, per_order, daily, weekly, monthly
4. **Set Weekly Day** — when invoicing period is `weekly`, set the day of the week (Monday–Sunday)
5. **Set Monthly Day** — when invoicing period is `monthly`, set the day of the month (1–28)

## Scope

**In scope:**

- Back Office screen/section for managing client settings per `ClientSupplierLink`
- API endpoint(s) to update `ClientSettingsSupplierControlled` fields
- Permission check: only supplier admins can modify settings
- Conditional fields: show Weekly Day only when period is `weekly`, Monthly Day only when period is `monthly`
- Confirmation dialog before blocking a client

**Out of scope:**

- Creating new client-supplier links (done via Django Admin)
- Client-side editing of supplier-controlled settings (already read-only)
- Notification system when settings change
- Bulk operations (batch block/unblock)

## Success Criteria

- [ ] Supplier admin can view all their linked clients with current settings
- [ ] Supplier admin can block/unblock a client
- [ ] Supplier admin can change fulfillment scheme (Delivery/Pickup)
- [ ] Supplier admin can change invoicing period
- [ ] Weekly Day field appears only when period is `weekly`
- [ ] Monthly Day field appears only when period is `monthly`
- [ ] Non-admin supplier users can view settings but not modify
- [ ] Changes are reflected in Supply Now profile screen (read-only)
- [ ] API validates input (valid weekday 0-6, valid monthday 1-28, valid period choices)

## Key Models

| Model | App | Role |
|-------|-----|------|
| `ClientSettingsSupplierControlled` | preferences | Stores supplier-controlled settings per link |
| `ClientSupplierLink` | actors | M2M link between client and supplier |
| `FulfillmentScheme` | fulfillment | Delivery or Pickup |
| `InvoicingPeriod` | invoicing | Period choices (manual, per_order, daily, weekly, monthly) |
| `Weekday` | common | Day of week choices (0=Monday to 6=Sunday) |

## API Endpoints Needed

| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/actors/clients/my-clients/` | List clients linked to supplier with their settings |
| PATCH | `/api/actors/clients/{id}/supplier-settings/` | Update supplier-controlled settings for a client |

## Key Risks

| Risk | Severity | Description |
|------|----------|-------------|
| Missing settings objects | :material-alert-outline: Medium | `ClientSettingsSupplierControlled` may not exist for all links — use `get_or_create` |
| Data validation | :material-alert-outline: Medium | Must validate period/day combinations (e.g., weekly_day required when period=weekly) |

---

!!! info "Related tasks"
    - [SN-01: Multi-Supplier Verification & Blocking](../supply-now/SN-01.md) — verifies the multi-supplier architecture
    - Supply Now already shows these settings as read-only in the Profile Suppliers tab
