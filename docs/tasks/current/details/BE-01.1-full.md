# BE-01.1: Full Task Details

> :material-arrow-left: Back to [summary card](../BE-01.1.md)

## Task Definition

### Original Request

"Acme Corporation" — это захардкоженный mock в Supply Now profile screen (`profile_screen.dart:522`). Данные не подтягиваются с API. Нужно:
- Выводить реальную компанию пользователя
- Если несколько компаний — выводить все
- Admin может редактировать компанию и настройки (`ClientSettingsSelfControlled`)
- `ClientControlledByPlatform` — видно всем, но `is_blocked` нельзя снять

### Clarifying Questions

1. **Отображение компаний** — Список клиентов на вкладке "Company". Если компаний несколько — вкладка "Companies (N)".

2. **Роли для редактирования** — Только Admin. Manager — только просмотр + подпись "Обратитесь к администратору: {admin_name}".

3. **Настройки** — `ClientSettingsSelfControlled`: Admin редактирует, Manager просматривает. `ClientControlledByPlatform.is_blocked`: видно всем, редактировать нельзя, выводится сообщение.

4. **Блокировка** — Баннер на карточке. Нельзя размещать заказы. При логине — сообщение если все клиенты заблокированы.

5. **Переключение клиента** — Да, через `PATCH /api/identity/users/me/`. Заблокированный клиент не может быть основным. Один клиент — основной по умолчанию, переключатель не показывается.

### Similar Implementations (Benchmarks)

| Benchmark | Location | What to reuse |
|-----------|----------|---------------|
| Back Office — Clients | `mobile/apps/back_office/lib/features/clients/` | Provider pattern, form screens, API calls |
| Supply Now — Suppliers Tab | `profile_screen.dart` (tab 2) | Same pattern: provider → API → list display |
| Shared Core — ClientsApiService | `shared_core/lib/src/api/clients_api_service.dart` | All CRUD methods already exist |
| Shared Core — ClientModel | `shared_core/lib/src/models/client_model.dart` | Freezed model ready to use |

### Refined Task Description

**Task Title**: Client Company Profile — Real Data & Settings

**Description**:
Replace hardcoded "Acme Corporation" on Supply Now Profile screen with real client data from API. Display all companies linked to user via `ClientUserLink`. Enable Admin editing of company details and self-controlled settings. Show platform block status as read-only. Implement current client switching for multi-company users.

**Use Cases**:

1. **Manager views company**: Opens Profile → Company tab → sees real company data (read-only) with "contact admin" hint
2. **Admin edits company**: Opens Profile → Company tab → taps edit → modifies company details → saves
3. **Admin edits settings**: Opens Profile → Company tab → settings section → edits language, delivery address, notifications
4. **Multi-company user**: Sees all companies in list, can switch current/primary client
5. **Blocked company**: User sees warning banner, cannot create orders for this client, cannot set it as primary
6. **All companies blocked**: User sees warning message at login

**Scope**:

- In scope:
  - Fetch user's clients via `client-user-link` API
  - Display client list on Company tab with dynamic tab title
  - Client card: name, official_name, VAT, address, logo, status
  - `ClientSettingsSelfControlled` fields display and editing
  - `ClientControlledByPlatform.is_blocked` read-only display
  - Role-based access (Admin edit, Manager read-only)
  - Current client switcher (multi-client)
  - Order blocking for blocked clients
  - Login-time warning for fully-blocked users

- Out of scope (not in this task):
  - Creating new clients from app
  - Deleting clients
  - Client address CRUD
  - Supplier-controlled settings
  - Admin panel changes

**Success Criteria**:

- [ ] Company tab shows real data from API (no hardcoded values)
- [ ] Tab title: "Company" (1) or "Companies (N)" (multiple)
- [ ] Client fields: name, official_name, VAT, address, logo
- [ ] `ClientSettingsSelfControlled` visible (language, delivery address, notifications, self-block)
- [ ] `ClientControlledByPlatform.is_blocked` shown read-only with message
- [ ] Admin can edit company and settings
- [ ] Manager sees read-only + "contact admin" hint
- [ ] Current client switcher works (multiple clients)
- [ ] Blocked client cannot be set as primary
- [ ] Order creation blocked for blocked clients
- [ ] Login message when all clients blocked
- [ ] No regressions on Personal and Suppliers tabs

**Technical Considerations**:

- `ClientUserLink` API may need nested client serializer for efficiency (avoid N+1 calls)
- `ClientControlledByPlatform` data may not be exposed via current API — need to verify/add
- Platform block must be enforced both client-side (UI) and server-side (API)
- Current client switching affects app-wide context (orders, products, etc.)

### Complexity Assessment

**Complexity**: Medium-High
**Estimated effort**: 8-12 hours

**Risk factors**:

- API may need adjustments for nested client data in `client-user-link` response
- Platform block enforcement needs both UI and API-level checks
- Order blocking logic touches multiple parts of the app
- Need test data with Admin role users and multiple client links

---

## Components to Modify

### Django Backend

| Component | Action | Details |
|-----------|--------|---------|
| `actors/serializers.py` | Verify/modify | Ensure `ClientUserLinkSerializer` returns nested client data |
| `actors/views.py` | Verify/modify | Ensure `client-user-link` filtering by current user works |
| `preferences/serializers.py` | Verify | Ensure `ClientControlledByPlatform` serializer exists for read |

### Flutter (Supply Now)

| Component | Action | Details |
|-----------|--------|---------|
| `profile_screen.dart` | Modify | Replace hardcoded Company tab with real data |
| `user_provider.dart` | Modify | Expose `currentClient` for switching |
| New: `client_provider.dart` | Create | Fetch user's clients via `client-user-link` API |
| New: `client_settings_provider.dart` | Create | Fetch/update `ClientSettingsSelfControlled` |
| New: `client_edit_screen.dart` | Create | Edit form for client details (Admin only) |
| New: `client_settings_screen.dart` | Create | Edit form for self-controlled settings (Admin only) |
| New: `client_card_widget.dart` | Create | Reusable client card with status badge |

### Database

- Migrations: none expected
- New tables/fields: none

---

## Dependencies

**Depends on**:

- `ClientUserLink` model and API (`/api/actors/client-user-link/`)
- `ClientsApiService` in shared_core package
- `ClientModel` in shared_core package
- `ClientSettingsSelfControlled` API (`/api/actors/clients/{id}/self-settings/`)
- `ClientControlledByPlatform` model

**Will affect**:

- Order creation flow (must check `is_blocked` before allowing orders)
- Authentication flow (login message for fully-blocked users)
- Profile screen UX (Company tab redesign)
- Current client context (used throughout the app)

---

## Recommended Approach

### Phase 1: Data Layer (2-3h)
1. Verify Django API: `client-user-link` returns nested client + role
2. Expose `ClientControlledByPlatform.is_blocked` via client detail or dedicated endpoint
3. Create Flutter providers: `clientsForUserProvider`, `clientSettingsProvider`

### Phase 2: Company Tab — Read-Only (3-4h)
4. Replace hardcoded data with real client list
5. Dynamic tab title
6. Client card widget with status badge
7. Show settings fields
8. Manager hint: "Contact admin: {name}"

### Phase 3: Admin Editing (2-3h)
9. Client edit form (Admin only)
10. Settings edit form (Admin only)
11. Current client switcher

### Phase 4: Blocking & Login (1-2h)
12. Block order creation for blocked clients
13. Login-time check for fully-blocked users
