# BUG-001: Ошибка 500 при сохранении чека

| Field | Value |
|-------|-------|
| **Status** | :material-check-circle:{ .text-green } **Fixed** |
| **App** | DocuFlow |
| **Reported** | 2026-02-16 |
| **Environment** | Production (docuflow.8move.ch) |
| **Severity** | High — блокирует сохранение чеков |

---

## Bug Report

### Summary

При нажатии кнопки Save на экране редактирования чека (receipt) сервер возвращает HTTP 500 (DioException [bad response]).

### Context

- Экран: "Détails du reçu #265"
- Приложение: Docuflow (docuflow.8move.ch)
- Пользователь сфотографировал чек, OCR обработал, пользователь нажал Save

### Actual Behavior

```
Échec de l'enregistrement : DioException [bad response]:
This exception was thrown because the response has a status code of 500
```

Чек НЕ сохраняется.

### Expected Behavior

Чек должен успешно сохраняться и возвращать пользователя к списку.

### Steps to Reproduce

1. Открыть receipt в Docuflow
2. Нажать кнопку Save
3. Получить ошибку 500

### Evidence

Скриншот: экран "Détails du reçu #265" (MIGROS, CHF, 04 Feb 2026) с ошибкой DioException 500.

---

## Investigation

### Root Cause

**Две связанные проблемы:**

#### 1. Missing `read_only_fields` in `ReceiptUpdateSerializer`

`ReceiptUpdateSerializer` (`app/receipts/serializers.py:218-241`) не имеет `read_only_fields`. Все поля writable, включая вычисляемые: `user`, `exchange_rate`, `amount_base`, `tax_base`.

Для сравнения, `ReceiptListSerializer` (строка 69) корректно определяет:
```python
read_only_fields = ['user', 'file_type', 'created_at', 'exchange_rate', 'amount_base', 'tax_base']
```

#### 2. Type mismatch в `compute_base_amounts()`

Flutter отправляет `exchange_rate`, `amount_base`, `tax_base` как **строки** в PATCH. Serializer сохраняет строки в Decimal-поля. При пересчёте курсов в `compute_base_amounts()` (`models.py:368`):

```python
self.amount_base = (self.amount * self.exchange_rate).quantize(Decimal('0.01'))
```

Умножение `Decimal * str` вызывает `TypeError` → **uncaught → 500**.

### Failure Chain

```
Flutter PATCH → exchange_rate: "0.938271" (string)
    ↓
ReceiptUpdateSerializer (no read_only_fields) → saves string to Decimal field
    ↓
perform_update() → ExchangeRateService.update_receipt_exchange_rate()
    ↓
compute_base_amounts() → Decimal * str → TypeError → 500
```

### Relevant Files

| File | Line | Role |
|------|------|------|
| `app/receipts/serializers.py` | 218-241 | `ReceiptUpdateSerializer` — **BUG: no read_only_fields** |
| `app/receipts/views.py` | 179-200 | `perform_update()` — exchange rate recalculation |
| `app/receipts/models.py` | 361-374 | `compute_base_amounts()` — no exception handling |
| `app/receipts/services/exchange_rate_service.py` | — | ExchangeRateService (correct, not the issue) |
| `mobile/.../receipt_detail_screen.dart` | 199-232 | Flutter `_saveReceipt()` sends computed fields |

---

## Proposed Fix

### Backend (required)

Add `read_only_fields` to `ReceiptUpdateSerializer`:

```python
class Meta:
    model = Receipt
    fields = [
        'user', 'merchant_name', 'merchant_address',
        'transaction_date', 'transaction_time',
        'amount', 'tax', 'currency',
        'exchange_rate', 'amount_base', 'tax_base',
        'category', 'client', 'payment_method',
        'description', 'expense_purpose', 'status',
    ]
    read_only_fields = ['user', 'exchange_rate', 'amount_base', 'tax_base']
```

### Flutter (optional)

Remove computed fields from PATCH data in `_saveReceipt()` — they will be ignored by backend anyway.

### Risk Assessment

- **Confidence**: High — pattern already used in `ReceiptListSerializer`
- **Affected**: Only receipt update (PATCH). Create and read are unaffected.
- **Side effects**: None expected. Server already recalculates these fields in `perform_update()`.

---

## Verification

- [x] Fix applied
- [ ] Bug no longer reproduces
- [ ] Related scenarios tested (create receipt, approve, reject)
- [ ] No regressions introduced

---

## Resolution Report

**Bug**: Ошибка 500 при сохранении чека в DocuFlow
**Status**: Fixed
**Date**: 2026-02-16

### Что было не так
При сохранении чека приложение отправляло на сервер вычисляемые поля (курс валюты, сумма в CHF) как текст. Сервер принимал эти данные без проверки и падал при попытке пересчитать суммы — текст нельзя умножить на число.

### Что сделано
- Серверная часть: заблокирована перезапись полей `user`, `exchange_rate`, `amount_base`, `tax_base` через API — теперь они вычисляются только на сервере
- Мобильное приложение: убрана отправка вычисляемых полей при сохранении чека

### Как проверить
1. Открыть любой чек в DocuFlow (docuflow.8move.ch)
2. Нажать кнопку Save
3. Убедиться, что чек сохраняется без ошибки
4. Проверить, что курс валюты и суммы в CHF корректно пересчитываются

### Затронутые области
- Сохранение чеков (Save / Save & Close)
- Пересчёт курсов валют при изменении суммы/валюты/даты
