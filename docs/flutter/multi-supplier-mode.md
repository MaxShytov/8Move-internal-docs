# Multi-Supplier Mode (Back Office)

## Что это такое

Multi-Supplier Mode — режим работы Back Office, при котором пользователь может переключаться между несколькими поставщиками (Suppliers). В хедере приложения появляется dropdown-переключатель с логотипами и названиями поставщиков.

## Когда появляется переключатель

Переключатель поставщиков **отображается автоматически**, если у пользователя есть доступ к **2 и более** поставщикам. Если у пользователя только 1 поставщик — переключатель скрыт, приложение работает как обычно.

## Как определяется список поставщиков

Список формируется на бэкенде через API `GET /api/actors/suppliers/` с Row-Level Access (RLA) фильтрацией.

**Правило:** Пользователь видит только тех поставщиков, к которым он **напрямую привязан** через таблицу `SupplierUserLink`.

| Тип связи | Видит поставщика? |
|---|---|
| `SupplierUserLink` (прямая связь user → supplier) | **Да** |
| Через клиентов (`ClientUserLink` → `ClientSupplierLink`) | **Нет** |

### Где это настраивается

- **Бэкенд:** `app/actors/models.py` → метод `Supplier.rla_roles_filter()`
- **Flutter:** `back_office/lib/core/providers.dart` → `suppliersListProvider`, `isMultiSupplierModeProvider`

## Как привязать пользователя к поставщику

1. Перейти в **Django Admin** → `Actors` → `Supplier user links`
2. Создать новую запись:
    - **User** — выбрать пользователя
    - **Supplier** — выбрать поставщика
    - **Role** — указать роль (admin, manager, и т.д.)
3. Сохранить

После этого пользователь увидит этого поставщика в переключателе Back Office.

## Поведение при переключении

1. Пользователь выбирает поставщика в dropdown
2. Выбор **сохраняется локально** на устройстве
3. Все данные в приложении (заказы, клиенты, товары) **перезагружаются** в контексте выбранного поставщика
4. При повторном входе в приложение — восстанавливается **последний выбранный** поставщик

## Что видит пользователь после переключения

При переключении на поставщика пользователь видит **все данные этого поставщика**:

- Все заказы от всех клиентов этого поставщика
- Всех клиентов, связанных с этим поставщиком
- Все товары, каталоги, настройки этого поставщика

Это корректное поведение — пользователь привязан к поставщику как сотрудник и имеет полный доступ к его данным.

## Суперпользователь

Суперпользователь (is_superuser) и платформенный администратор (is_platform_admin) видят **всех** поставщиков в системе без ограничений RLA-фильтра. Также суперпользователь может принудительно включить/выключить multi-supplier mode.

## Troubleshooting

| Проблема | Причина | Решение |
|----------|---------|---------|
| Пользователь не видит переключатель | У него только 1 поставщик | Добавить `SupplierUserLink` к ещё одному поставщику |
| Пользователь видит «лишних» поставщиков | Есть записи в `SupplierUserLink` | Удалить ненужные записи в Django Admin |
| После переключения нет данных | Поставщик без заказов/клиентов | Нормальное поведение — данных просто нет |
| Переключатель не запоминает выбор | Проблема с локальным хранилищем | Очистить кэш браузера / приложения |
